<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>genieacs源码剖析 | Martin | 爱设计，爱创造|To design and create</title>

  
  <meta name="author" content="Martin Yong">
  

  
  <meta name="description" content="Simple Art">
  

  
  
  <meta name="keywords" content="通信">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="genieacs源码剖析">

  <meta property="og:site_name" content="Martin">

  
  <meta property="og:image" content="/blog/favicon.ico">
  

  <link href="/blog/favicon.ico" rel="icon">
  <link rel="alternate" href="/blog/atom.xml" title="Martin" type="application/atom+xml">
  <link rel="stylesheet" href="/blog/css/style.css" media="screen" type="text/css">
  <!-- ketax style -->
  <link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/blog/">Martin</a>
    </h1>
    <p class="site-description">爱设计，爱创造|To design and create</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/blog/">主页</a></li>
      
        <li><a href="/blog/archives">归档</a></li>
      
        <li><a href="/blog/categories/tech">技术</a></li>
      
        <li><a href="/blog/categories/life">生活</a></li>
      
        <li><a href="/blog/categories/casual">随笔</a></li>
      
        <li><a href="/blog/categories/project">项目</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>genieacs源码剖析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/blog/posts/tech/2018.11.05-genieacs源码剖析.html" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-05T09:15:12.000Z">
          2018-11-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <blockquote>
<p>A fast and lightweight TR-069 Auto Configuration Server (ACS)</p>
</blockquote>
<h3 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h3><p><a href="https://github.com/genieacs/genieacs" target="_blank" rel="noopener">Genieacs</a></p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">├── bin 存放入口文件</span><br><span class="line">│   ├── genieacs-cwmp 主体程序可执行脚本</span><br><span class="line">│   ├── genieacs-fs 文件服务可执行脚本</span><br><span class="line">│   └── genieacs-nbi RESTFUL API服务可执行脚本</span><br><span class="line">├── config 存放配置参数文件及拓展插件文件</span><br><span class="line">│   ├── auth-sample.js</span><br><span class="line">│   ├── auth.js</span><br><span class="line">│   ├── config-sample.json</span><br><span class="line">│   ├── config.json</span><br><span class="line">│   └── ext-sample.js</span><br><span class="line">├── debug</span><br><span class="line">├── lib 存放核心文件</span><br><span class="line">│   ├── api-functions.js</span><br><span class="line">│   ├── auth.js 处理http认证</span><br><span class="line">│   ├── cache.js</span><br><span class="line">│   ├── cluster.js 调用cluster模块逻辑</span><br><span class="line">│   ├── common.js 存放处理变量的方法</span><br><span class="line">│   ├── config.js 获取配置参数</span><br><span class="line">│   ├── cwmp.js</span><br><span class="line">│   ├── db.js 数据库查询</span><br><span class="line">│   ├── default-provisions.js</span><br><span class="line">│   ├── device.js</span><br><span class="line">│   ├── extension-wrapper.js</span><br><span class="line">│   ├── extensions.js</span><br><span class="line">│   ├── fs.js</span><br><span class="line">│   ├── gpn-heuristic.js</span><br><span class="line">│   ├── instance-set.js</span><br><span class="line">│   ├── local-cache.js</span><br><span class="line">│   ├── logger.js 日志</span><br><span class="line">│   ├── nbi.js</span><br><span class="line">│   ├── path-set.js</span><br><span class="line">│   ├── query.js</span><br><span class="line">│   ├── sandbox.js</span><br><span class="line">│   ├── scheduling.js</span><br><span class="line">│   ├── server.js 启动http服务</span><br><span class="line">│   ├── session.js</span><br><span class="line">│   ├── soap.js XMLSOAP处理(包括解析和打包)</span><br><span class="line">│   └── versioned-map.js</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h4><p><em>bin</em>目录下三个文件均为入口启动文件，代表三种不同的服务。对比可看出，三个文件的逻辑一致。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// genieacs-cwmp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取项目绝对路径</span></span><br><span class="line"><span class="keyword">var</span> dir = path.resolve(path.dirname(fs.realpathSync(__filename)), <span class="string">'..'</span>);</span><br><span class="line">process.chdir(dir);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用cluster，启动cwmp服务</span></span><br><span class="line"><span class="keyword">var</span> cluster = <span class="built_in">require</span>(path.resolve(dir, <span class="string">'lib/cluster'</span>));</span><br><span class="line">cluster.start(<span class="string">'cwmp'</span>);</span><br></pre></td></tr></table></figure>
<p>接下来是cluster，cluster模块是nodejs默认自带的，用于同时启动多个进程。<a href="https://www.nodeapp.cn/cluster.html" target="_blank" rel="noopener">具体介绍</a> \ <a href="https://cnodejs.org/topic/56e84480833b7c8a0492e20c" target="_blank" rel="noopener">原理</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cluster.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回依赖版本信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDependencyVersions</span>(<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回配置参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getConfig</span>(<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重启worker</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restartWorker</span>(<span class="params">worker, code, signal</span>) </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">service</span>) </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置集群参数</span></span><br><span class="line">cluster.setupMaster(&#123;</span><br><span class="line">    exec: <span class="string">"lib/server"</span>,</span><br><span class="line">    args: [service]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> workerCount = config.get(<span class="string">`<span class="subst">$&#123;service.toUpperCase()&#125;</span>_WORKER_PROCESSES`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!workerCount) workerCount = <span class="built_in">Math</span>.max(<span class="number">2</span>, <span class="built_in">require</span>(<span class="string">"os"</span>).cpus().length);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 派生子进程</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; workerCount; ++i) cluster.fork();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是server.js，用于启动http服务与数据库连接。</p>
<h4 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h4><p><em>lib</em>目录下有对应三个服务的文件:<em>cwmp.js</em>、<em>nbi.js</em>、<em>fs.js</em>, 这三个文件都暴露了<strong>listener</strong>方法供<em>server.js</em>使用，用于处理http请求。下面对<em>cwmp.js</em>进行展开。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态记录</span></span><br><span class="line"><span class="keyword">const</span> stats = &#123;</span><br><span class="line">  concurrentRequests: <span class="number">0</span>,</span><br><span class="line">  totalRequests: <span class="number">0</span>,</span><br><span class="line">  droppedRequests: <span class="number">0</span>,</span><br><span class="line">  initiatedSessions: <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应cpe inform请求</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inform</span>(<span class="params">sessionContext, rpc</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 记录</span></span><br><span class="line">    session.inform(sessionContext, rpc.cpeRequest, (err, acsResponse) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">void</span> throwError(err, sessionContext.httpResponse);</span><br><span class="line">    <span class="comment">// 将数据打包为SOAP格式</span></span><br><span class="line">    <span class="keyword">const</span> res = soap.response(&#123;</span><br><span class="line">      id: rpc.id,</span><br><span class="line">      acsResponse: acsResponse,</span><br><span class="line">      cwmpVersion: sessionContext.cwmpVersion</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 设置cookie, 内容主要为sessionId</span></span><br><span class="line">    <span class="keyword">const</span> cookiesPath = config.get(<span class="string">"COOKIES_PATH"</span>, sessionContext.deviceId);</span><br><span class="line">    <span class="keyword">if</span> (cookiesPath) &#123;</span><br><span class="line">      res.headers[<span class="string">"Set-Cookie"</span>] = <span class="string">`session=<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        sessionContext.sessionId</span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>; Path=<span class="subst">$&#123;cookiesPath&#125;</span>`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.headers[<span class="string">"Set-Cookie"</span>] = <span class="string">`session=<span class="subst">$&#123;sessionContext.sessionId&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送响应</span></span><br><span class="line">    writeResponse(sessionContext, res);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取session</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSession</span>(<span class="params">connection, sessionId, callback</span>) </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理请求</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processRequest</span>(<span class="params">sessionContext, rpc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rpc.cpeRequest) &#123;</span><br><span class="line">        <span class="comment">// 判断不同的cpe请求</span></span><br><span class="line">        <span class="keyword">if</span> (rpc.cpeRequest.name === <span class="string">"Inform"</span>) &#123;</span><br><span class="line">          <span class="comment">// 记录日志</span></span><br><span class="line">          logger.accessInfo(&#123;</span><br><span class="line">            sessionContext: sessionContext,</span><br><span class="line">            message: <span class="string">"Inform"</span>,</span><br><span class="line">            rpc: rpc</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">// 处理inform请求</span></span><br><span class="line">          inform(sessionContext, rpc);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(...) &#123;...&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listener</span>(<span class="params">httpRequest, httpResponse</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 获取sessionId</span></span><br><span class="line">  <span class="keyword">let</span> sessionId;</span><br><span class="line">  <span class="comment">// Separation by comma is important as some devices don't comform to standard</span></span><br><span class="line">  <span class="keyword">const</span> COOKIE_REGEX = <span class="regexp">/\s*([a-zA-Z0-9\-_]+?)\s*=\s*"?([a-zA-Z0-9\-_]*?)"?\s*(,|;|$)/g</span>;</span><br><span class="line">  <span class="keyword">let</span> match;</span><br><span class="line">  <span class="keyword">while</span> ((match = COOKIE_REGEX.exec(httpRequest.headers.cookie)))</span><br><span class="line">    <span class="keyword">if</span> (match[<span class="number">1</span>] === <span class="string">"session"</span>) sessionId = match[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> stream = httpRequest;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数据量统计</span></span><br><span class="line">  <span class="keyword">const</span> chunks = [];</span><br><span class="line">  <span class="keyword">let</span> bytes = <span class="number">0</span>;</span><br><span class="line">  stream.on(<span class="string">"data"</span>, chunk =&gt; &#123;</span><br><span class="line">    chunks.push(chunk);</span><br><span class="line">    bytes += chunk.length;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  stream.on(<span class="string">"end"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 拷贝一份请求数据</span></span><br><span class="line">    <span class="keyword">const</span> body = Buffer.allocUnsafe(bytes);</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> chunk <span class="keyword">of</span> chunks) &#123;</span><br><span class="line">      chunk.copy(body, offset, <span class="number">0</span>, chunk.length);</span><br><span class="line">      offset += chunk.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parsedRpc</span>(<span class="params">sessionContext, rpc, parseWarnings</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 处理请求</span></span><br><span class="line">      processRequest(sessionContext, rpc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 尝试同步session</span></span><br><span class="line">    getSession(httpRequest.connection, sessionId, (err, sessionContext) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">void</span> throwError(err, httpResponse);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (sessionContext) &#123;</span><br><span class="line">        sessionContext.httpRequest = httpRequest;</span><br><span class="line">        sessionContext.httpResponse = httpResponse;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          sessionContext.sessionId !== sessionId ||</span><br><span class="line">          sessionContext.lastActivity + sessionContext.timeout * <span class="number">1000</span> &lt;</span><br><span class="line">            <span class="built_in">Date</span>.now()</span><br><span class="line">        ) &#123;</span><br><span class="line">          logger.accessError(&#123;</span><br><span class="line">            message: <span class="string">"Invalid session"</span>,</span><br><span class="line">            sessionContext: sessionContext</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">          httpResponse.writeHead(<span class="number">400</span>, &#123; <span class="attr">Connection</span>: <span class="string">"close"</span> &#125;);</span><br><span class="line">          httpResponse.end(<span class="string">"Invalid session"</span>);</span><br><span class="line">          stats.concurrentRequests -= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stats.concurrentRequests &gt; MAX_CONCURRENT_REQUESTS) &#123;</span><br><span class="line">        <span class="comment">// Check again just in case device included old session ID</span></span><br><span class="line">        <span class="comment">// from the previous session</span></span><br><span class="line">        httpResponse.writeHead(<span class="number">503</span>, &#123; <span class="string">"Retry-after"</span>: <span class="number">60</span>, <span class="attr">Connection</span>: <span class="string">"close"</span> &#125;);</span><br><span class="line">        httpResponse.end(<span class="string">"503 Service Unavailable"</span>);</span><br><span class="line">        stats.droppedRequests += <span class="number">1</span>;</span><br><span class="line">        stats.concurrentRequests -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 解析请求发送过来的xml数据</span></span><br><span class="line">      <span class="keyword">const</span> parseWarnings = [];</span><br><span class="line">      <span class="keyword">let</span> rpc;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        rpc = soap.request(</span><br><span class="line">          body,</span><br><span class="line">          sessionContext ? sessionContext.cwmpVersion : <span class="literal">null</span>,</span><br><span class="line">          parseWarnings</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        logger.accessError(&#123;</span><br><span class="line">          message: <span class="string">"XML parse error"</span>,</span><br><span class="line">          parseError: error.message.trim(),</span><br><span class="line">          sessionContext: sessionContext || &#123;</span><br><span class="line">            httpRequest: httpRequest,</span><br><span class="line">            httpResponse: httpResponse</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        httpResponse.writeHead(<span class="number">400</span>, &#123; <span class="attr">Connection</span>: <span class="string">"close"</span> &#125;);</span><br><span class="line">        httpResponse.end(error.message);</span><br><span class="line">        stats.concurrentRequests -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 已存在session的话</span></span><br><span class="line">      <span class="keyword">if</span> (sessionContext) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          (rpc.cpeRequest &amp;&amp; rpc.cpeRequest.name === <span class="string">"Inform"</span>) ||</span><br><span class="line">          !sessionContext.rpcRequest ^ !(rpc.cpeResponse || rpc.cpeFault)</span><br><span class="line">        ) &#123;</span><br><span class="line">          logger.accessError(&#123;</span><br><span class="line">            message: <span class="string">"Bad session state"</span>,</span><br><span class="line">            sessionContext: sessionContext</span><br><span class="line">          &#125;);</span><br><span class="line">          httpResponse.writeHead(<span class="number">400</span>, &#123; <span class="attr">Connection</span>: <span class="string">"close"</span> &#125;);</span><br><span class="line">          httpResponse.end(<span class="string">"Bad session state"</span>);</span><br><span class="line">          stats.concurrentRequests -= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">void</span> parsedRpc(sessionContext, rpc, parseWarnings);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 仅允许inform请求</span></span><br><span class="line">      <span class="keyword">if</span> (!(rpc.cpeRequest &amp;&amp; rpc.cpeRequest.name === <span class="string">"Inform"</span>)) &#123;</span><br><span class="line">        logger.accessError(&#123;</span><br><span class="line">          message: <span class="string">"Invalid session"</span>,</span><br><span class="line">          sessionContext: sessionContext || &#123;</span><br><span class="line">            httpRequest: httpRequest,</span><br><span class="line">            httpResponse: httpResponse</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        httpResponse.writeHead(<span class="number">400</span>, &#123; <span class="attr">Connection</span>: <span class="string">"close"</span> &#125;);</span><br><span class="line">        httpResponse.end(<span class="string">"Invalid session"</span>);</span><br><span class="line">        stats.concurrentRequests -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 新建一个session</span></span><br><span class="line">      stats.initiatedSessions += <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">const</span> deviceId = common.generateDeviceId(rpc.cpeRequest.deviceId);</span><br><span class="line"></span><br><span class="line">      session.init(</span><br><span class="line">        deviceId,</span><br><span class="line">        rpc.cwmpVersion,</span><br><span class="line">        rpc.sessionTimeout || config.get(<span class="string">"SESSION_TIMEOUT"</span>, deviceId),</span><br><span class="line">        (err, _sessionContext) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">void</span> throwError(err, httpResponse);</span><br><span class="line"></span><br><span class="line">          _sessionContext.httpRequest = httpRequest;</span><br><span class="line">          _sessionContext.httpResponse = httpResponse;</span><br><span class="line">          _sessionContext.sessionId = crypto.randomBytes(<span class="number">8</span>).toString(<span class="string">"hex"</span>);</span><br><span class="line">          httpRequest.connection.setTimeout(_sessionContext.timeout * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">          getDueTasksAndFaultsAndOperations(</span><br><span class="line">            deviceId,</span><br><span class="line">            _sessionContext.timestamp,</span><br><span class="line">            (err, dueTasks, faults, operations, cacheUntil) =&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">void</span> throwError(err, httpResponse);</span><br><span class="line"></span><br><span class="line">              _sessionContext.tasks = dueTasks;</span><br><span class="line">              _sessionContext.operations = operations;</span><br><span class="line">              _sessionContext.cacheUntil = cacheUntil;</span><br><span class="line">              _sessionContext.faults = faults;</span><br><span class="line">              _sessionContext.retries = &#123;&#125;;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">const</span> [k, v] <span class="keyword">of</span> <span class="built_in">Object</span>.entries(_sessionContext.faults)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (v.expiry &gt;= _sessionContext.timestamp) &#123;</span><br><span class="line">                  <span class="comment">// Delete expired faults</span></span><br><span class="line">                  <span class="keyword">delete</span> _sessionContext.faults[k];</span><br><span class="line">                  <span class="keyword">if</span> (!_sessionContext.faultsTouched)</span><br><span class="line">                    _sessionContext.faultsTouched = &#123;&#125;;</span><br><span class="line">                  _sessionContext.faultsTouched[k] = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  _sessionContext.retries[k] = v.retries;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              parsedRpc(_sessionContext, rpc, parseWarnings);</span><br><span class="line">            &#125;</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="preset-功能"><a href="#preset-功能" class="headerlink" title="preset 功能"></a>preset 功能</h4><p>官方wiki中并没有详细提及到此功能，以下将对此进行展开：</p>
<p><em>preset</em>在数据库中单独开一个表，字段主要有channel、weight、schedule、events、precondition、configurations。</p>
<p><em>channel</em> 类型为string，默认为”default”，主要用来作为过滤发生错误的preset的依据。如果一个preset执行的时候发生了错误（fault），那么同一channel的preset都将不会被执行。</p>
<p><em>weight</em> 类型为number，默认为0，主要用来排序，规则为升序。weight越低，越先被执行。</p>
<p><em>events</em> 类型为object，默认为空。主要用来作为preset的启动条件。格式为<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"0 BOOTSTRAP"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"1 BOOT"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>schedule</em> 类型为string，默认为空。指preset运行的周期。一般情况下，符合条件的设备每一次inform到来时都会执行一次。而配置此字段可指定preset运行的周期。格式为”duration cron”, 如<code>&quot;300 0 0 0 * * ?&quot;</code> 指每天执行一次。duration一般指设备inform的频率(官方并没介绍，此结论是笔者通过实验得出)，单位为秒。</p>
<p><em>precondition</em> 类型为JSON string，用于筛选设备。</p>
<p><em>configurations</em> 类型为array，指本preset的所有配置项。</p>
<h5 id="关于批量重启、重置和更新固件"><a href="#关于批量重启、重置和更新固件" class="headerlink" title="关于批量重启、重置和更新固件"></a>关于批量重启、重置和更新固件</h5><p>在preset的配置项中，有一个非常重要的功能——<em>provision</em>。</p>
<p>通常情况下，用户可定义自己的<strong>provision脚本</strong>，用于实现更加复杂的操作，具体怎样不在此展开，可参考<a href="https://github.com/genieacs/genieacs/wiki/Provisions" target="_blank" rel="noopener">官方wiki介绍</a></p>
<p>回到怎么实现重启、重置和更新固件的问题上，用户一般可以发布针对某个设备的任务来执行这样的操作。但是任务不能实现设备批量筛选、时间计划<em>cron</em>等功能。</p>
<p>官方源码中为我们提供了方法来实现,就是<em>provision</em>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// default-provisions.js</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// 重启</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reboot</span>(<span class="params">sessionContext, provision, declarations, startRevision, endRevision</span>) </span>&#123;</span><br><span class="line">  declarations.push([[<span class="string">"Reboot"</span>], <span class="number">1</span>, &#123;<span class="attr">value</span>: <span class="number">1</span>&#125;, <span class="literal">null</span>, &#123;<span class="attr">value</span>: [sessionContext.timestamp]&#125;]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重置</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params">sessionContext, provision, declarations, startRevision, endRevision</span>) </span>&#123;</span><br><span class="line">  declarations.push([[<span class="string">"FactoryReset"</span>], <span class="number">1</span>, &#123;<span class="attr">value</span>: <span class="number">1</span>&#125;, <span class="literal">null</span>, &#123;<span class="attr">value</span>: [sessionContext.timestamp]&#125;]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下载</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params">sessionContext, provision, declarations, startRevision, endRevision</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> alias = [[<span class="string">"FileType"</span>], provision[<span class="number">1</span>] || <span class="string">""</span>, [<span class="string">"FileName"</span>], provision[<span class="number">2</span>] || <span class="string">""</span>,</span><br><span class="line">    [<span class="string">"TargetFileName"</span>], provision[<span class="number">3</span>] || <span class="string">""</span>];</span><br><span class="line"></span><br><span class="line">  declarations.push([[<span class="string">"Downloads"</span>, alias], <span class="number">1</span>, &#123;&#125;, <span class="number">1</span>]);</span><br><span class="line">  declarations.push([[<span class="string">"Downloads"</span>, alias, <span class="string">"Download"</span>], <span class="number">1</span>, &#123;<span class="attr">value</span>: <span class="number">1</span>&#125;, <span class="literal">null</span>,</span><br><span class="line">    &#123;<span class="attr">value</span>: [sessionContext.timestamp]&#125;]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// session.js</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runProvisions</span>(<span class="params">sessionContext,provisions,startRevision,endRevision,callback</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> allProvisions = provisionsCache.get(sessionContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [j, provision] <span class="keyword">of</span> provisions.entries()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!allProvisions[provision[<span class="number">0</span>]]) &#123;</span><br><span class="line">        allDeclarations[j] = [];</span><br><span class="line">        allClear[j] = [];</span><br><span class="line">        <span class="keyword">if</span> (defaultProvisions[provision[<span class="number">0</span>]]) &#123;</span><br><span class="line">          done =</span><br><span class="line">            defaultProvisions[provision[<span class="number">0</span>]](</span><br><span class="line">              sessionContext,</span><br><span class="line">              provision,</span><br><span class="line">              allDeclarations[j],</span><br><span class="line">              startRevision,</span><br><span class="line">              endRevision</span><br><span class="line">            ) &amp;&amp; done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>根据以上源码，我们只要将provision的name写成以上三个函数名之一(reboot、reset、download)就可以实现对应的操作。</p>
<p>而更新固件还需要额外加三个参数：FileType、FileName、TargetFileName，须写在<em>argument</em>中，用<code>,</code>进行分隔，例子抓包如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"channel"</span>:<span class="string">"12"</span>,<span class="attr">"weight"</span>:<span class="number">0</span>,<span class="attr">"precondition"</span>:<span class="string">"&#123;\"Device.DeviceInfo.SerialNumber\":\"xxxxxxxxxxxxx\"&#125;"</span>,<span class="attr">"configurations"</span>:[&#123;<span class="attr">"type"</span>:<span class="string">"provision"</span>,<span class="attr">"name"</span>:<span class="string">"download"</span>,<span class="attr">"args"</span>:[<span class="string">"1 Firmware Upgrade Image"</span>,<span class="string">"ruijie.bin"</span>,<span class="string">"ruijie.bin"</span>]&#125;],<span class="attr">"schedule"</span>:<span class="string">""</span>,<span class="attr">"events"</span>:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/blog/categories/tech/">技术</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/blog/tags/通信/">通信</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 Martin Yong
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-143426112-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>